# Механизмы хранения данных и обеспечение безопасности

В приложении RealEstateAssistant PRO реализованы современные подходы к хранению и защите данных, соответствующие лучшим практикам разработки для платформы Android.

## Механизмы хранения данных

### 1. Локальная база данных SQLite с использованием Room

Основным хранилищем данных приложения является локальная база данных SQLite, доступ к которой осуществляется через ORM-библиотеку Room.

#### Основные характеристики системы хранения:

- **Полное шифрование базы данных** с использованием SQLCipher
- **Поддержка миграций** для обновления схемы базы данных между версиями приложения
- **Асинхронная инициализация** с использованием корутин для улучшения производительности
- **Механизмы восстановления** в случае повреждения базы данных

#### Структура базы данных:

База данных содержит следующие основные таблицы:

1. **properties** - объекты недвижимости
2. **clients** - клиенты
3. **appointments** - встречи и показы
4. **bookings** - бронирования и договоры аренды

#### Основные DAO (Data Access Object):

- **PropertyDao** - операции с объектами недвижимости
- **ClientDao** - операции с клиентами
- **AppointmentDao** - операции с встречами
- **BookingDao** - операции с бронированиями

### 2. SharedPreferences для пользовательских настроек

Для хранения пользовательских настроек и небольших наборов данных используется механизм SharedPreferences:

- **Обычные SharedPreferences** - для хранения несекретных пользовательских настроек
- **EncryptedSharedPreferences** - для хранения чувствительных данных (например, паролей)

#### Управление настройками:

Для удобной работы с SharedPreferences разработан класс `PreferencesManager`, который обеспечивает:

- Типобезопасный доступ к настройкам
- Поддержку хранения примитивных типов (строки, числа, логические значения)
- Поддержку хранения списков и объектов через сериализацию в JSON
- Методы для очистки и проверки наличия данных

### 3. Конвертеры типов для Room

Для хранения сложных типов данных в базе SQLite используются TypeConverter-ы:

- **ListStringConverter** - конвертер для списков строк
- **SeasonalPriceListConverter** - конвертер для списков сезонных цен
- **AppointmentStatusConverter** - конвертер для статусов встреч
- **AppointmentTypeConverter** - конвертер для типов встреч
- **BookingConverters** - конвертеры для бронирований

## Обеспечение безопасности и конфиденциальности

### 1. Шифрование базы данных

База данных полностью шифруется с использованием SQLCipher:

```kotlin
val passphrase = SQLiteDatabase.getBytes(databaseEncryption.getDatabasePassword().toCharArray())
val factory = SupportFactory(passphrase)

val instance = Room.databaseBuilder(
    context.applicationContext,
    AppDatabase::class.java,
    DATABASE_NAME
)
.openHelperFactory(factory)
.addMigrations(/* ... */)
.build()
```

### 2. Безопасное хранение пароля базы данных

Для безопасного хранения пароля базы данных используется класс `DatabaseEncryption`, который:

1. Использует **EncryptedSharedPreferences** из библиотеки AndroidX Security для шифрования ключа шифрования базы данных
2. Применяет **AES256_GCM** для шифрования значений и **AES256_SIV** для шифрования ключей
3. Содержит механизм восстановления в случае повреждения криптографических ключей:
   ```kotlin
   if (e is AEADBadTagException || e.cause is AEADBadTagException) {
       Log.w(TAG, "Обнаружено повреждение криптографических ключей, сбрасываю хранилище")
       resetEncryptedStorage()
   }
   ```

4. Включает запасной режим работы с обычными SharedPreferences в случае критических ошибок в системе шифрования

### 3. Защита от повреждения данных

В приложении реализованы механизмы для обеспечения целостности данных:

1. **Проверка целостности базы данных** при инициализации:
   ```kotlin
   try {
       instance.openHelper.readableDatabase
       instance.openHelper.writableDatabase
   } catch (e: Exception) {
       // Восстановление при повреждении базы данных
   }
   ```

2. **Механизм восстановления** в случае повреждения базы данных:
   - Удаление поврежденных файлов базы данных
   - Удаление журнала WAL, файлов SHM
   - Создание новой базы данных при необходимости

3. **Откат к незашифрованному хранилищу** в случае критических проблем с системой шифрования

### 4. Резервное копирование и синхронизация

Модель данных включает поля для отслеживания состояния синхронизации:

```kotlin
val isSynced: Boolean = false
val createdAt: Long = System.currentTimeMillis()
val updatedAt: Long = System.currentTimeMillis()
```

## Сущности базы данных

### 1. PropertyEntity

Сущность для хранения информации об объектах недвижимости:

- Общая информация (адрес, тип, площадь, количество комнат)
- Геолокация (координаты, район)
- Характеристики объекта (состояние ремонта, количество спален и ванных комнат)
- Условия проживания (разрешения для детей и животных)
- Условия для длительной аренды (месячная плата, депозит)
- Условия для посуточной аренды (цена за сутки, скидки, минимальный срок)
- Фотографии и документы

### 2. ClientEntity

Сущность для хранения информации о клиентах:

- Контактная информация (ФИО, телефон)
- Информация о клиенте (состав семьи, дети, животные)
- Предпочтения по аренде (район, бюджет, тип недвижимости)
- Предпочтения для длительной аренды
- Предпочтения для посуточной аренды

### 3. AppointmentEntity

Сущность для хранения информации о встречах и показах:

- Данные о встрече (дата, время начала и окончания)
- Связи с объектом недвижимости и клиентом
- Информация о повторяющихся встречах
- Участники и напоминания

### 4. BookingEntity

Сущность для хранения информации о бронированиях и договорах аренды:

- Связи с объектом недвижимости и клиентом
- Даты заезда и выезда
- Финансовая информация (общая сумма, депозит, статус оплаты)
- Дополнительные услуги и примечания

## Оптимизация хранения данных

- Использование `Flow` для обновления данных в реальном времени
- Применение `suspend` функций для асинхронных операций
- Использование транзакций для обеспечения атомарности операций
- Индексирование полей для оптимизации поиска

## Обработка ошибок

В системе реализованы механизмы обработки и логирования ошибок:

1. **Отлов и логирование исключений** при операциях с базой данных
2. **Автоматическое восстановление** при повреждении базы данных
3. **Резервные решения** при критических ошибках шифрования

## Заключение

Система хранения данных приложения RealEstateAssistant PRO построена с учетом современных требований к безопасности и производительности:

- **Комплексное шифрование всех данных** с использованием проверенных криптографических алгоритмов
- **Защита от повреждения данных** с автоматическим восстановлением
- **Гибкая система хранения** с поддержкой различных типов данных
- **Оптимизированная структура базы данных** для высокой производительности 